# Implementation Plan

## 実装タスク一覧

- [x] 1. Docker Compose開発環境のポート設定を更新
- [x] 1.1 開発環境のPostgreSQLポートマッピングを変更
  - docker-compose.ymlのpostgresサービスポート設定を"15432:5432"に更新
  - 環境変数POSTGRES_PORTのデフォルト値を15432に設定
  - postgresサービスのヘルスチェック設定が新ポートで動作することを確認
  - バックエンドサービスのDATABASE_URL環境変数が正しくコンテナ内部ポート5432を参照していることを確認
  - _Requirements: 1.1, 1.3, 4.1, 4.3_

- [x] 1.2 開発環境の動作検証テストを実施
  - docker compose downで既存環境を停止
  - docker compose upで新ポート設定の環境を起動
  - PostgreSQLコンテナがホストポート15432でリッスンしていることを確認
  - バックエンドコンテナがデータベースに正常に接続できることを確認
  - _Requirements: 1.1, 1.2, 7.4_

- [x] 2. Docker Composeテスト環境のポート設定を更新
- [x] 2.1 テスト環境のPostgreSQLポートマッピングを変更
  - docker-compose.test.ymlのdb-testサービスポート設定を"15433:5432"に更新
  - backend-testサービスのDATABASE_URL環境変数がコンテナ内部ポート5432を使用していることを確認
  - mcp-serverサービスのDATABASE_URL環境変数が正しく設定されていることを確認
  - db-testサービスのヘルスチェック設定を検証
  - _Requirements: 2.1, 2.3, 4.2, 4.4_

- [ ] 2.2 テスト環境の動作検証とE2Eテストを実施
  - docker compose -f docker-compose.test.yml downで既存テスト環境を停止
  - docker compose -f docker-compose.test.yml upで新ポート設定のテスト環境を起動
  - PostgreSQLコンテナがホストポート15433でリッスンしていることを確認
  - E2Eテストを実行し、全テストが成功することを確認
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 3. 環境変数テンプレートとサンプル設定を更新
- [x] 3.1 .env.exampleファイルのポート設定を更新
  - POSTGRES_PORT変数の値を15432に変更
  - DATABASE_URLサンプルのポート番号を15432に更新
  - ポート管理コメントセクションの開発環境ポート情報を更新（postgres=15432）
  - ポート管理コメントセクションのテスト環境ポート情報を更新（postgres=15433）
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 4. ポートチェックスクリプトを新ポート番号に対応
- [x] 4.1 check-ports.jsのデフォルトポート設定を更新
  - DEFAULT_PORTSオブジェクトのpostgres値を15432に変更
  - DEFAULT_PORTSオブジェクトのpostgres_test値を15433に変更
  - getPortConfig関数が.envファイルから正しくポート番号を読み込むことを確認
  - 環境変数未設定時のデフォルト値が正しく適用されることを確認
  - _Requirements: 6.1, 6.2_

- [x] 4.2 ポートチェックスクリプトの動作検証を実施
  - 開発モードでスクリプトを実行し、ポート15432の検証が行われることを確認
  - テストモードでスクリプトを実行し、ポート15433の検証が行われることを確認
  - ポート競合時に適切なエラーメッセージが表示されることを確認
  - Dockerコンテナ使用時にコンテナ名と停止コマンドが表示されることを確認
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 5. プロジェクトドキュメントを新ポート番号に更新
- [x] 5.1 README.mdのポート情報を更新
  - クイックスタートガイドのPostgreSQLアクセス情報を"localhost:15432"に変更
  - サービスポート一覧表のpostgresエントリを"15432 (dev) / 15433 (test)"に更新
  - Docker Services表のpostgresポート情報を更新
  - docker compose execコマンド例のポート番号を確認
  - _Requirements: 5.1, 5.2_

- [x] 5.2 backend/README.mdのデータベース設定を更新
  - DATABASE_URL接続文字列の例をポート15432を含む形式に変更
  - データベースセットアップ手順のポート番号を更新
  - ローカル開発環境の説明でポート15432を明記
  - _Requirements: 5.3_

- [x] 5.3 .kiro/steering/tech.mdの技術スタック情報を更新
  - ポート管理セクションの開発環境PostgreSQLポートを15432に変更
  - ポート管理セクションのテスト環境PostgreSQLポートを15433に変更
  - 環境変数セクションのPOSTGRES_PORT例を15432に更新
  - DATABASE_URL例のポート番号を15432に更新
  - _Requirements: 5.4_

- [ ] 6. 既存システムとの互換性を検証
- [ ] 6.1 既存データベースボリュームとの互換性を確認
  - 既存のpostgres-dataボリュームが存在する状態で新ポート設定の環境を起動
  - 既存データに正常にアクセスできることを確認
  - Prisma Studioを新ポート15432経由で起動し、データベースに接続できることを確認
  - データの整合性が保たれていることを確認
  - _Requirements: 7.1, 7.2_

- [ ] 6.2 バックエンドヘルスチェックとデータベース接続を検証
  - バックエンドのヘルスチェックエンドポイント(/api/v1/health)にアクセス
  - データベース接続確認が成功することを確認
  - docker compose down → docker compose upのサイクルで全サービスが正常起動することを確認
  - ログにエラーがないことを確認
  - _Requirements: 7.3, 7.4_

- [ ] 7. ロールバック機能と後方互換性を実装・検証
- [ ] 7.1 環境変数によるポート設定オーバーライド機能を検証
  - .envファイルでPOSTGRES_PORT=5432を明示的に設定
  - docker compose down → docker compose upで環境を再起動
  - PostgreSQLが旧ポート5432で起動することを確認
  - バックエンドが旧ポート経由でデータベースに接続できることを確認
  - _Requirements: 8.1, 8.2_

- [ ] 7.2 ロールバック手順をドキュメント化
  - .env.exampleファイルにロールバック手順をコメントとして追加
  - ロールバック手順: 環境変数変更とコンテナ再起動のみで完了することを明記
  - トラブルシューティングセクションに旧ポート設定への復元方法を追加
  - チーム向けの移行通知とロールバック手順を準備
  - _Requirements: 8.3, 8.4_

- [ ] 8. 統合テストと最終検証を実施
- [ ] 8.1 全環境での統合テストを実施
  - クリーン環境（ボリューム削除）からの開発環境起動テスト
  - クリーン環境からのテスト環境起動とE2Eテスト実行
  - ポートチェックスクリプトが全ての新ポート番号を正しく検証することを確認
  - Prismaマイグレーションが新ポート経由で正常に実行されることを確認
  - _Requirements: 1.4, 全般的な統合検証_

- [ ] 8.2 ドキュメントとコード設定の整合性を最終確認
  - すべての設定ファイル（docker-compose.yml, docker-compose.test.yml, .env.example）が一貫したポート番号を使用していることを確認
  - すべてのドキュメント（README.md, backend/README.md, tech.md）が正確なポート情報を記載していることを確認
  - ポートチェックスクリプトのDEFAULT_PORTSが設定ファイルと一致していることを確認
  - 要件トレーサビリティマトリクスで全要件がカバーされていることを確認
  - _Requirements: 全要件の最終確認_
