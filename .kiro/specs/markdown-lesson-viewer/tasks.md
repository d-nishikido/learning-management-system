# 実装計画

## Phase 1: 新規コンポーネント実装

- [x] 1. マークダウンレンダリング用の依存関係をインストール
  - react-markdown（バージョン ^9.0.0）をプロジェクトに追加
  - remark-gfm（バージョン ^4.0.0）でGitHub Flavored Markdownサポートを追加
  - rehype-sanitize（バージョン ^6.0.0）でセキュリティサニタイゼーション機能を追加
  - react-syntax-highlighter（バージョン ^15.5.0）でコードハイライト機能を追加
  - package.jsonの依存関係を更新して型定義を含める
  - _要件: 1.1, 1.2, 1.3, 2.1_

- [ ] 2. マークダウンビューワーコンポーネントの実装
- [x] 2.1 基本的なマークダウンビューワーを作成
  - マークダウンコンテンツを受け取りHTMLに変換する機能
  - react-markdownを使用した安全なレンダリング機能
  - remark-gfmプラグインで標準マークダウン構文（見出し、リスト、テーブル、引用等）をサポート
  - rehype-sanitizeプラグインでXSS攻撃を防ぐサニタイゼーション機能
  - 空コンテンツ時のフォールバック表示機能
  - proseスタイルクラスでTypographyスタイリングを適用
  - _要件: 1.1, 1.2, 1.4, 2.1_

- [x] 2.2 コードブロックハイライトコンポーネントを作成
  - react-syntax-highlighterを使用したシンタックスハイライト機能
  - 言語識別子（className）から言語を自動検出する機能
  - インラインコードとブロックコードを判別する機能
  - Prism Light Buildで必要な言語のみをインポート（JavaScript, TypeScript, JSX, TSX, Python, Java, C, C++, Go, Rust, SQL, HTML, CSS, JSON, YAML）
  - コードブロックのスタイリング（背景色、パディング、横スクロール）
  - _要件: 1.3, 3.2, 6.4_

- [x] 2.3 外部リンクレンダラーを作成
  - 外部リンク（http/https）を検出する機能
  - 外部リンクにrel="noopener noreferrer"属性を自動付与
  - 外部リンクにtarget="_blank"を設定
  - 内部リンク（相対パス）はそのまま表示
  - リンクのスタイリング（色、下線、ホバー効果）
  - _要件: 2.2_

- [x] 2.4 画像レンダラーを作成
  - 画像の表示機能
  - 画像読み込みエラーのハンドリング機能
  - エラー時に代替テキストとアイコンを表示
  - 画像のレスポンシブ表示（max-width: 100%）
  - alt属性の保持とアクセシビリティ対応
  - _要件: 2.3, 3.1, 6.3_

- [x] 3. マークダウンビューワーのユニットテストを作成
  - マークダウンが正しくHTMLに変換されることをテスト
  - XSS攻撃ベクトル（scriptタグ、onerror等）がサニタイズされることをテスト
  - 標準マークダウン構文（見出し、リスト、リンク、画像、コードブロック、テーブル）が正しくレンダリングされることをテスト
  - 空コンテンツ時にフォールバックが表示されることをテスト
  - 外部リンクにrel="noopener noreferrer"が付与されることをテスト
  - 画像エラー時に代替UIが表示されることをテスト
  - コードブロックのシンタックスハイライトが適用されることをテスト
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3_

## Phase 2: LessonDetail統合

- [ ] 4. レッスン詳細ページにマークダウンビューワーを統合
- [x] 4.1 既存のdangerouslySetInnerHTMLをマークダウンビューワーに置き換え
  - LessonDetail.tsxの既存のコンテンツ表示部分を特定
  - dangerouslySetInnerHTMLを使用している箇所をMarkdownViewerコンポーネントに置き換え
  - lesson.contentをMarkdownViewerに渡す
  - 空コンテンツ時の既存メッセージ表示をフォールバックとして設定
  - proseクラスとmax-w-noneクラスを維持してレイアウトを保持
  - _要件: 1.1, 1.4_

- [x] 4.2 レスポンシブ表示の確認と調整
  - デスクトップ、タブレット、モバイルでのレイアウト確認
  - コードブロックの横スクロール動作を確認
  - テーブルのモバイル表示を確認
  - 画像のレスポンシブ表示を確認
  - 必要に応じてTailwind CSSクラスを調整
  - _要件: 3.1, 3.2, 3.3_

- [x] 5. レッスン詳細ページの統合テストを実施
  - レッスンAPIからマークダウンコンテンツを取得してレンダリングされることをテスト
  - マークダウンコンテンツが正しくフォーマットされて表示されることをテスト
  - コードブロックのシンタックスハイライトが正常に動作することをテスト
  - 外部リンクと画像が正しく表示されることをテスト
  - 既存のHTMLコンテンツも問題なく表示されることをテスト（後方互換性）
  - _要件: 1.1, 1.2, 1.3, 2.2, 2.3_

## Phase 3: LessonForm統合

- [ ] 6. マークダウンエディターコンポーネントを実装
- [x] 6.1 基本的なマークダウンエディターを作成
  - マークダウンテキストを編集するためのテキストエリア機能
  - 親フォームとの双方向データバインディング（value/onChangeプロパティ）
  - プレースホルダー、高さ、エラーメッセージ、無効化フラグのサポート
  - デスクトップ用の2カラムレイアウト（編集エリアとプレビューエリアを並列表示）
  - モバイル用の1カラムレイアウト（編集/プレビューのタブ切り替え）
  - Tailwind CSSを使用したスタイリング
  - _要件: 4.1_

- [x] 6.2 マークダウンプレビューコンポーネントを作成
  - 編集中のマークダウンをリアルタイムでプレビュー表示する機能
  - MarkdownViewerコンポーネントを内部的に使用して一貫したレンダリング
  - プレビューエリアのスタイリング（背景、ボーダー、パディング）
  - プレビューエリアの高さを編集エリアと同期
  - 学習者が見るのと同じスタイルでレンダリング
  - _要件: 4.2, 4.3_

- [x] 6.3 マークダウンヘルプコンポーネントを作成
  - マークダウン記法のヘルプを表示するモーダルまたはポップオーバー機能
  - 基本的なマークダウン構文例を表示（見出し、リスト、コードブロック、リンク、画像、テーブル、引用）
  - 構文カテゴリごとにセクション分け
  - 各構文例をクリックして編集エリアに挿入する機能
  - ヘルプボタンまたはリンクの表示機能
  - lucide-reactアイコンを使用したUI
  - _要件: 5.1, 5.2, 5.3_

- [ ] 7. レッスンフォームにマークダウンエディターを統合
  - LessonForm.tsxの既存のcontentフィールド入力部分を特定
  - 既存のテキストエリアをMarkdownEditorコンポーネントに置き換え
  - formData.contentとMarkdownEditorのvalueを同期
  - handleChangeイベントをMarkdownEditorのonChangeに接続
  - マークダウンヘルプボタンを追加
  - バリデーションエラーの表示を維持
  - _要件: 4.1, 5.1_

- [ ] 8. マークダウンエディターのユニットテストを作成
  - onChangeコールバックが入力時に呼び出されることをテスト
  - プレビューがリアルタイムで更新されることをテスト
  - モバイルビューでタブ切り替えが動作することをテスト
  - マークダウンヘルプモーダルが開閉することをテスト
  - 構文挿入コールバックが正しいマークダウン構文を渡すことをテスト
  - _要件: 4.1, 4.2, 5.2, 5.3_

- [ ] 9. レッスンフォームの統合テストを実施
  - レッスンフォームでマークダウン編集が可能であることをテスト
  - プレビューが編集内容とリアルタイムで同期することをテスト
  - マークダウンヘルプが正常に動作することをテスト
  - 保存時にマークダウンコンテンツがAPIに送信されることをテスト
  - 保存したマークダウンがレッスン詳細ページで正しく表示されることをテスト
  - _要件: 4.1, 4.2, 4.3, 5.2, 5.3_

## Phase 4: テストと最適化

- [ ] 10. E2Eテストを実施
- [ ] 10.1 学習者フローのE2Eテストを作成
  - Playwrightでレッスン詳細ページにアクセスするテスト
  - マークダウンコンテンツが適切にレンダリングされていることを確認するテスト
  - コードブロック、リンク、画像が正常に表示されることを確認するテスト
  - レスポンシブ表示（モバイル、タブレット、デスクトップ）を確認するテスト
  - _要件: 1.1, 1.2, 1.3, 2.2, 2.3, 3.1_

- [ ] 10.2 管理者フローのE2Eテストを作成
  - Playwrightでレッスンフォームを開くテスト
  - マークダウンを編集し、プレビューがリアルタイムで更新されることを確認するテスト
  - マークダウンヘルプを開き、構文を挿入できることを確認するテスト
  - レッスンを保存し、詳細ページで正しく表示されることを確認するテスト
  - _要件: 4.1, 4.2, 5.2, 5.3_

- [ ] 11. パフォーマンステストと最適化
  - 小規模コンテンツ（1KB）のレンダリング時間を計測（目標: 100ms以内）
  - 中規模コンテンツ（10KB）のレンダリング時間を計測（目標: 500ms以内）
  - 大規模コンテンツ（100KB）のレンダリング時間を計測（目標: 3秒以内）
  - 10個のコードブロックを含むコンテンツのレンダリング時間を計測（目標: 1秒以内）
  - React.memoでMarkdownViewerコンポーネントをメモ化
  - useMemoでマークダウンレンダリング結果をキャッシュ
  - react-syntax-highlighterのLight Buildで必要な言語のみをインポート
  - _要件: 6.1_

- [ ] 12. アクセシビリティテストを実施
  - セマンティックHTML要素が使用されていることを確認
  - 画像のalt属性が保持されていることを確認
  - コードブロックがスクリーンリーダーで読み上げ可能であることを確認
  - キーボードナビゲーションが機能することを確認
  - WCAG 2.1 AA準拠を確認
  - _要件: 6.2, 6.3, 6.4_

## Phase 5: 本番デプロイ

- [ ] 13. 本番環境へのデプロイ
  - フロントエンドのビルドを実行（npm run build）
  - ビルドエラーがないことを確認
  - 型チェックを実行（npm run typecheck）
  - リントを実行（npm run lint）
  - 本番環境にデプロイ
  - デプロイ後の動作確認
  - _要件: 全要件_

- [ ] 14. 本番環境での検証
  - レッスン詳細ページでマークダウンが正しく表示されることを確認
  - レッスンフォームでマークダウン編集が正常に動作することを確認
  - XSS攻撃ベクトルがサニタイズされることを確認
  - パフォーマンスメトリクスを満たすことを確認（3秒以内）
  - エラーログに重大なエラーがないことを確認
  - ユーザーフィードバックを収集
  - _要件: 全要件_
