# 実装計画

## 概要

本実装計画は、メイン教材進捗率記入機能の実装タスクを定義します。既存の進捗管理システムを拡張し、手動進捗率入力のためのバックエンドAPIと履歴管理機能、フロントエンドUIコンポーネントを順次実装します。

---

## データベース層

- [x] 1. 進捗履歴管理のためのデータベース基盤を構築
- [x] 1.1 進捗履歴テーブルのスキーマを定義
  - 進捗レコードとの関連付けを設定
  - 進捗率、学習時間、変更者、メモを記録できる構造を作成
  - 日時ソート用のインデックスを設定
  - カスケード削除により整合性を保証
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 1.2 既存進捗テーブルとの関連付けを設定
  - 進捗履歴への参照リレーションを追加
  - データベースマイグレーションを実行
  - 既存データとの互換性を確認
  - _Requirements: 2.1, 6.4_

---

## バックエンドAPI層

- [x] 2. 進捗履歴管理サービスを実装
- [x] 2.1 進捗履歴の記録機能を構築
  - 進捗更新時に自動的に履歴を保存する仕組みを作成
  - 変更日時、進捗率、学習時間、変更者を記録
  - トランザクション内で進捗更新と履歴記録を同時実行
  - _Requirements: 2.1_

- [x] 2.2 進捗履歴の取得機能を構築
  - 教材IDとユーザーIDで履歴を取得
  - 日時の新しい順にソート
  - 前回進捗率との差分を計算
  - 履歴が存在しない場合の空配列返却
  - _Requirements: 2.2, 2.3, 2.4_

- [x] 3. 進捗更新APIエンドポイントを拡張
- [x] 3.1 手動進捗率更新エンドポイントを実装
  - 進捗率、学習時間、メモを受け取るAPIを作成
  - リクエストバリデーションを実装（0-100範囲チェック、型チェック）
  - 認証ミドルウェアを適用
  - 成功・エラーレスポンスを返却
  - _Requirements: 1.3, 1.4, 1.5, 5.1, 5.3, 6.1, 6.3_

- [x] 3.2 進捗履歴取得エンドポイントを実装
  - 教材別の進捗履歴を返すAPIを作成
  - 認証済みユーザーのみアクセス可能に設定
  - ページネーション対応（オプション）
  - _Requirements: 2.2, 2.4_

- [x] 4. 進捗計算ロジックを強化
- [x] 4.1 レッスン進捗の再計算機能を実装
  - レッスン内の全教材進捗を集計
  - 手動進捗と自動進捗を統合して計算
  - レッスンの総合進捗率を算出
  - _Requirements: 3.1, 3.2_

- [x] 4.2 コース進捗の自動更新機能を実装
  - レッスン進捗の更新時にコース全体の進捗を再計算
  - レッスン数に基づいた重み付け計算
  - _Requirements: 3.4_

- [x] 5. 進捗完了処理を実装
- [x] 5.1 100%達成時の完了ステータス更新を実装
  - 進捗率が100%になったら完了フラグを設定
  - 完了日時を記録
  - 学習ストリークの更新をトリガー
  - _Requirements: 1.6_

- [x] 5.2 進行中への状態復帰機能を実装
  - 完了済み教材の進捗率を100%未満に変更時、完了フラグを解除
  - 完了日時をnullにリセット
  - _Requirements: 1.7_

---

## フロントエンド層

- [x] 6. 進捗率入力UIコンポーネントを構築
- [x] 6.1 基本的な進捗率入力フォームを実装
  - 0-100の数値入力フィールドを作成
  - リアルタイムバリデーション機能を実装
  - 範囲外値・非数値のエラーメッセージ表示
  - モバイル最適化された数値キーパッド入力を設定
  - _Requirements: 1.2, 1.4, 1.5, 4.5_

- [x] 6.2 プログレスバープレビュー機能を実装
  - 現在の進捗率を視覚的に表示するプログレスバーを作成
  - 入力値の変更に応じてリアルタイムでプレビュー更新
  - _Requirements: 1.1, 4.1, 4.2_

- [x] 6.3 クイック選択ボタンを実装
  - 0%, 25%, 50%, 75%, 100%のボタンを配置
  - クリック時に入力フィールドへ即座に値を設定
  - _Requirements: 4.3, 4.4_

- [x] 6.4 学習時間とメモの入力欄を追加
  - オプション入力として学習時間（分）フィールドを作成
  - メモ入力用のテキストエリアを追加
  - _Requirements: 2.1_

- [x] 7. 進捗率更新機能を統合
- [x] 7.1 APIクライアント機能を実装
  - 進捗率更新APIとの通信ロジックを作成
  - リクエスト/レスポンスの型定義を追加
  - エラーハンドリングを実装
  - _Requirements: 1.3, 5.3, 5.4_

- [x] 7.2 カスタムフック（useProgressUpdate）を実装
  - 進捗更新のためのReactフックを作成
  - ローディング状態の管理
  - エラー状態の管理
  - 成功時のコールバック処理
  - _Requirements: 1.3_

- [x] 7.3 フォーム送信処理を実装
  - バリデーション成功時にAPI呼び出し
  - 送信中のローディング表示
  - 送信完了後のUI更新
  - _Requirements: 1.3_

- [x] 8. フィードバックと通知機能を実装
- [x] 8.1 成功通知メッセージを実装
  - 進捗率更新成功時の通知を3秒間表示
  - 100%達成時の祝福メッセージを表示
  - _Requirements: 5.1, 5.2_

- [x] 8.2 エラー通知とリトライ機能を実装
  - エラー原因を説明するメッセージを表示
  - ネットワークエラー時の再試行ボタンを提供
  - エクスポネンシャルバックオフによる自動リトライ
  - _Requirements: 5.3, 5.4_

- [x] 9. 進捗履歴表示機能を実装
- [x] 9.1 履歴取得カスタムフック（useProgressHistory）を実装
  - 進捗履歴取得APIとの通信ロジックを作成
  - 履歴データのキャッシング
  - ローディング状態の管理
  - _Requirements: 2.2_

- [x] 9.2 進捗履歴一覧コンポーネントを実装
  - 日時、進捗率、変更差分を表示するリストを作成
  - 日時の新しい順にソート表示
  - 履歴が存在しない場合のメッセージ表示
  - メモがある場合はメモも表示
  - _Requirements: 2.2, 2.3, 2.4_

- [x] 10. 進捗ダッシュボードとの統合
- [x] 10.1 手動進捗と自動進捗の統合表示を実装
  - ダッシュボードに手動進捗教材を含めて表示
  - 進捗タイプ（自動/手動）の識別表示
  - _Requirements: 3.3_

- [x] 10.2 レッスン・コース進捗の自動更新を実装
  - 手動進捗更新後にダッシュボードデータを再取得
  - レッスン進捗率の再計算結果を反映
  - コース進捗率の再計算結果を反映
  - _Requirements: 3.1, 3.2, 3.4, 7.2_
  - 手動進捗更新後にダッシュボードデータを再取得
  - レッスン進捗率の再計算結果を反映
  - コース進捗率の再計算結果を反映
  - _Requirements: 3.1, 3.2, 3.4, 7.2_

---

## テスト層

- [ ] 11. バックエンドのユニットテストを実装
- [ ] 11.1 進捗履歴サービスのテストを作成
  - 履歴記録機能の正常系テスト
  - 履歴取得機能の正常系テスト（ソート順確認）
  - 履歴が存在しない場合の空配列返却テスト
  - _Requirements: 2.1, 2.2, 2.4_

- [ ] 11.2 進捗更新サービスのテストを作成
  - 有効な進捗率での更新成功テスト
  - 手動進捗不許可教材でのエラーテスト
  - 進捗率100%で完了ステータス更新テスト
  - レッスン進捗再計算の正確性テスト
  - コース進捗再計算の正確性テスト
  - _Requirements: 1.3, 1.6, 3.1, 3.2, 3.4_

- [ ] 12. バックエンドの統合テストを実装
- [ ] 12.1 進捗更新APIの統合テストを作成
  - 正常系: 進捗率更新成功レスポンス確認
  - 異常系: 未認証ユーザーの401エラー確認
  - 異常系: 手動進捗不許可教材の422エラー確認
  - トランザクション整合性: UserProgressとProgressHistoryの同時作成確認
  - _Requirements: 1.3, 2.1, 6.1, 6.3_

- [ ] 12.2 進捗履歴取得APIの統合テストを作成
  - 正常系: 履歴取得成功レスポンス確認
  - 異常系: 未認証ユーザーの401エラー確認
  - 空履歴時のレスポンス確認
  - _Requirements: 2.2, 2.4, 6.3_

- [x] 13. フロントエンドのユニットテストを実装
- [x] 13.1 進捗入力フォームのテストを作成
  - バリデーション: 0未満の値でエラーメッセージ表示
  - バリデーション: 100超過の値でエラーメッセージ表示
  - クイック選択: ボタンクリックで進捗率設定
  - リアルタイムプレビュー: 入力値変更でプログレスバー更新
  - フォーム送信: バリデーション成功時のonSubmit呼び出し
  - _Requirements: 1.4, 1.5, 4.2, 4.3, 4.4_

- [x] 13.2 カスタムフックのテストを作成
  - useProgressUpdate: API呼び出しとローディング状態管理
  - useProgressHistory: 履歴取得とキャッシング動作
  - エラーハンドリング: ネットワークエラー時のリトライ
  - _Requirements: 1.3, 2.2, 5.4_

- [x] 14. E2Eテスト（Playwright）を実装
- [x] 14.1 クリティカルユーザーパスのテストを作成
  - ログイン → 教材詳細 → 進捗率入力 → 保存 → 成功メッセージ確認
  - 進捗率100%入力 → 完了メッセージ表示 → ダッシュボードで完了ステータス確認
  - 進捗履歴タブ → 履歴一覧表示 → 日時・進捗率・差分の表示確認
  - クイック選択ボタン → プログレスバープレビュー → 保存 → 反映確認
  - 範囲外値入力 → バリデーションエラー表示 → 修正 → 保存成功
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.2, 2.3, 4.2, 4.3, 5.1, 5.2_

- [ ] 15. パフォーマンステストを実装
- [ ] 15.1 負荷テストシナリオを作成
  - 同時100ユーザーでの進捗更新APIレスポンスタイム測定（目標: 3秒以内）
  - 同時500ユーザーでの進捗更新API測定（目標: 10秒以内）
  - 大量履歴データ（1000件）取得時のレスポンスタイム測定（目標: 2秒以内）
  - データベースクエリの実行計画最適化確認
  - _Requirements: 7.1, 7.2, 7.3_

---

## セキュリティとデータ整合性

- [ ] 16. セキュリティ対策を実装
- [ ] 16.1 認証・認可チェックを強化
  - JWT認証ミドルウェアの適用確認
  - ユーザーIDによる所有権検証
  - 他ユーザーの進捗更新試行時の権限エラー返却
  - _Requirements: 6.3, 6.5_

- [ ] 16.2 入力サニタイゼーションとバリデーションを実装
  - SQLインジェクション対策: Prismaパラメータ化クエリ使用確認
  - XSS対策: メモフィールドのサニタイゼーション
  - 進捗率のDecimal型による厳密な範囲制限
  - _Requirements: 6.1, 6.4_

- [ ] 17. データ整合性制約を実装
- [ ] 17.1 トランザクション管理を実装
  - 進捗更新と履歴記録の同一トランザクション実行
  - エラー時の自動ロールバック
  - 同時更新時の楽観的ロック制御
  - _Requirements: 6.2_

---

## 統合とデプロイ準備

- [ ] 18. 教材詳細ページへの統合
- [ ] 18.1 進捗入力UIを教材詳細ページに配置
  - 手動進捗許可教材でのみ進捗入力フォームを表示
  - 自動進捗教材では表示しない
  - 既存の教材詳細レイアウトとの統合
  - _Requirements: 1.1, 1.2_

- [ ] 18.2 進捗履歴タブを追加
  - 教材詳細ページに履歴表示タブを追加
  - タブ切り替え時に履歴データを取得
  - _Requirements: 2.2_

- [ ] 19. 最終統合テストと調整
- [ ] 19.1 全体フローの統合確認
  - 進捗入力 → 履歴記録 → レッスン進捗更新 → コース進捗更新 → ダッシュボード反映
  - エラーハンドリングフローの確認
  - パフォーマンス目標達成確認
  - _Requirements: 全要件_

- [ ] 19.2 ブラウザ互換性とレスポンシブ対応確認
  - Chromium、Firefox、WebKitでの動作確認
  - モバイルデバイスでのUI表示確認
  - タッチ操作の動作確認
  - _Requirements: 4.5_
