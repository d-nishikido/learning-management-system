# メイン教材の進捗率入力方法ガイド

## 問題の診断結果

ユーザーがメイン教材の進捗率をどこから入力すればよいかわからない状態でした。調査の結果、進捗入力機能は正しく実装されており、以下の手順でアクセス可能です。

## アクセス方法

### 1. レッスン詳細ページから教材を開く

**手順:**
1. **コース一覧**にアクセス (`/courses`)
2. 学習したい**コース**を選択
3. コース詳細ページで**レッスン**を選択
4. レッスン詳細ページで**教材カード**をクリック

**URL構造:**
```
/courses/:courseId/lessons/:lessonId
```

### 2. 教材ビューアーで進捗入力フォームを表示

教材をクリックすると、**MaterialViewer**（教材ビューアー）モーダルが開きます。

**進捗入力フォームが表示される条件:**
- 教材の`allowManualProgress`が`true`である
- **または** 教材の`materialType`が`MANUAL_PROGRESS`である

これらの条件を満たす教材では、教材コンテンツの下に自動的に**MaterialProgressContainer**が表示されます。

## 進捗入力UIの構造

### タブナビゲーション

教材ビューアーには2つのタブがあります：

1. **進捗率入力タブ** (デフォルト表示)
   - 進捗率入力フォーム
   - プログレスバープレビュー
   - クイック選択ボタン (0%, 25%, 50%, 75%, 100%)
   - 学習時間入力 (オプション)
   - メモ入力 (オプション)

2. **進捗履歴タブ**
   - 過去の進捗変更履歴を表示
   - 日時、進捗率、変更差分を表示
   - 新しい順にソート表示

### 進捗率入力フォームの使い方

**入力フィールド:**
- **進捗率**: 0-100の整数を入力
- **学習時間**: 学習にかかった時間（分）を入力（オプション）
- **メモ**: 学習の振り返りやメモを入力（オプション）

**クイック選択ボタン:**
- ワンクリックで0%, 25%, 50%, 75%, 100%を設定可能

**プログレスバープレビュー:**
- 入力値がリアルタイムで視覚的に表示される

**保存ボタン:**
- フォームを送信して進捗率を更新
- バリデーション成功時にAPI呼び出し
- 成功時にトースト通知を表示

## バリデーションルール

### 進捗率の検証
- **範囲**: 0-100の整数のみ許可
- **0未満**: 「0-100の範囲で入力してください」エラー
- **100超過**: 「0-100の範囲で入力してください」エラー
- **非数値**: 「数値を入力してください」エラー

### 学習時間の検証
- **オプション入力**: 入力しなくても保存可能
- **正の整数**: 入力する場合は0以上の整数

## 成功メッセージ

### 通常の進捗更新
- **メッセージ**: 「進捗率を更新しました」
- **表示時間**: 3秒

### 100%達成時
- **メッセージ**: 「🎉 おめでとうございます！教材を完了しました」
- **表示時間**: 5秒
- **効果**: 教材が「完了」ステータスに更新される

## エラーハンドリング

### ネットワークエラー
- エラーメッセージを表示
- **再試行ボタン**を提供
- ボタンをクリックすると同じデータで再送信

### 認証エラー
- 認証が必要な場合は401エラー
- ログインページへのリダイレクトを促す

### バリデーションエラー
- フロントエンドとバックエンドの両方で検証
- エラーメッセージをフォーム下部に表示

## ダッシュボードへの反映

進捗率を更新すると、以下が自動的に更新されます：

1. **教材の進捗率**: 即座に反映
2. **レッスンの進捗率**: 自動再計算
3. **コースの進捗率**: 自動再計算
4. **ダッシュボードの統計**: 自動更新（カスタムイベント経由）

**更新タイミング**: 進捗更新成功後、5秒以内にダッシュボードに反映されます。

## 実装ファイル

### フロントエンド
- **MaterialViewer.tsx** (`frontend/src/components/materials/MaterialViewer.tsx:328`)
  - 教材ビューアーモーダル
  - MaterialProgressContainerを表示

- **MaterialProgressContainer.tsx** (`frontend/src/components/progress/MaterialProgressContainer.tsx`)
  - 進捗入力と履歴表示のコンテナ
  - タブナビゲーション管理

- **ProgressInputForm.tsx** (`frontend/src/components/progress/ProgressInputForm.tsx`)
  - 進捗率入力フォームUI

- **ProgressHistoryList.tsx** (`frontend/src/components/progress/ProgressHistoryList.tsx`)
  - 進捗履歴表示

### カスタムフック
- **useProgressUpdate.ts** (`frontend/src/hooks/useProgressUpdate.ts`)
  - 進捗更新API通信

- **useProgressHistory.ts** (`frontend/src/hooks/useProgressHistory.ts`)
  - 進捗履歴取得API通信

### バックエンド
- **progressController.ts** (`backend/src/controllers/progressController.ts`)
  - 進捗更新APIエンドポイント

- **progressService.ts** (`backend/src/services/progressService.ts`)
  - 進捗計算とデータベース操作

## トラブルシューティング

### 進捗入力フォームが表示されない場合

**原因1: 教材が手動進捗を許可していない**
- 確認方法: 教材の`allowManualProgress`プロパティを確認
- 解決策: 管理者に教材設定の変更を依頼

**原因2: 教材のタイプがMANUAL_PROGRESSではない**
- 確認方法: 教材の`materialType`プロパティを確認
- 解決策: 管理者に教材タイプの変更を依頼

**原因3: 認証切れ**
- 確認方法: コンソールで401エラーを確認
- 解決策: 再ログイン

### 進捗率が保存できない場合

**原因1: バリデーションエラー**
- 確認方法: フォーム下部のエラーメッセージを確認
- 解決策: 0-100の範囲内の整数を入力

**原因2: ネットワークエラー**
- 確認方法: ブラウザのネットワークタブでエラーを確認
- 解決策: 再試行ボタンをクリック

**原因3: サーバーエラー**
- 確認方法: コンソールで500エラーを確認
- 解決策: 管理者にサーバーログの確認を依頼

## 結論

メイン教材の進捗率入力機能は正常に実装されており、以下の導線でアクセス可能です：

**コース一覧 → コース詳細 → レッスン詳細 → 教材カード → 教材ビューアー → 進捗入力フォーム**

進捗入力フォームは、手動進捗が許可された教材（`allowManualProgress=true`または`materialType=MANUAL_PROGRESS`）で自動的に表示されます。
